<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Markdownビューア</title>
    <style>
        body {
			max-width: 480px;
			margin: 0 auto;
			padding: 20px;
		}
        #markdown-content img {
			max-width: 100%;
			height: auto;
		}
		ul {
			padding: 0 0 0 1.5rem;
			line-height: 175%;
		}
    </style>
</head>
<body>
    <div id="markdown-content"></div>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/lib/marked.umd.min.js"></script>
    <script>

	// パスのディレクトリのみ返す
	function getDir(path) {
		const index = path.lastIndexOf('/');
		return (index < 0) ? '.' : path.substring(0, index);
	}

	async function loadAndRenderMarkdown() {
		const outBox = document.getElementById('markdown-content');
		const params = new URLSearchParams(window.location.search);
		const markdownUrl = params.get('md');
		if (!markdownUrl) {
			outBox.innerHTML = `
				<h1>Markdownファイルが指定されていません</h1>
				<p>例： <a href="mdv.html?md=data/026-秋分.md">mdv.html?md=data/026-秋分.md</a></p>
			`;
			return;
		}

		try {
			const response = await fetch(markdownUrl);
			if (!response.ok) {
				outBox.innerHTML =`
					HTTPエラー: ${response.status} ${response.statusText}
					`;
				return;
			}
			const mdText = await response.text();

			// markdownUrl のディレクトリ部分を baseDir に取り出す
			const baseDir = getDir(markdownUrl);

			// 画像リンクが相対パスなら、baseDirからの相対パスに変換する
			const re_image = /!\[(.*?)\]\((.*?)\)/g;
			const re_http = /^https?:\/\//;
			const mdText2 = mdText.replace(re_image, (match, alt, url) => {
				if (!re_http.test(url)) {
					url = `${baseDir}/${url}`;
				}
				return `![${alt}](${url})`;
			});

			// MarkDownをHTMLに変換する
			const html = marked.parse(mdText2);
			outBox.innerHTML = html;

		} catch (error) {
			outBox.innerHTML = `
				<h1>エラーが発生しました</h1>
				<p>${error.message}</p>
				<p>指定されたURL: ${markdownUrl}</p>
				`;
		}
	}

	loadAndRenderMarkdown();

	</script> 
</body>
</html>
